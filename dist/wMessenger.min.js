!function(t,e){"function"==typeof define&&define.amd?define(e):t.wMessenger=e()}(this,function(){"use strict";var r=[],a="wMessenger-",i=function(){return+new Date};return{addListener:function(n){n=n||{};var o=[];if("[object Function]"!==Object.prototype.toString.call(n.cb))throw new Error("wMessenger Error: cb值必须为函数");if("[object String]"===Object.prototype.toString.call(n.key))o.push(a+n.key);else{if(!Array.isArray(n.key))throw new Error("wMessenger Error: 监听的key值必须为字符串或字符串数组");o=n.key.map(function(t){return a+t})}var t=function(t){var e;if(-1!==o.indexOf(t.key)&&(e=null===t.oldValue?"add":null===t.newValue?"delete":"update",!n.type||n.type===e)){var r,a=JSON.parse(t.newValue);if(a&&(r=/^\{.*\}$/.test(a.data)||/^\[.*\]$/.test(a.data)?JSON.parse(a.data):a.data),void 0!==n.data&&null!==n.data)if(Array.isArray(n.data)||"[object Object]"===Object.prototype.toString.call(n.data)){if(JSON.stringify(n.data)!==a.data)return}else if(n.data!==a.data)return;n.cb(r)}},e=i();return r[e]=t,window.addEventListener("storage",t,!0),e},removeListener:function(t){r[t]&&window.removeEventListener("storage",r[t],!0),r[t]=null},broadcast:function(t){if(!(t=t||{}).key||"[object String]"!==Object.prototype.toString.call(t.key))throw new Error("wMessenger Error: 广播的key值必须为字符串");var e={};e.t=(new Date).getTime()+""+Math.floor(1e3*Math.random()),void 0!==t.data&&null!==t.data&&(Array.isArray(t.data)||"[object Object]"===Object.prototype.toString.call(t.data)?e.data=JSON.stringify(t.data):e.data=t.data),window.localStorage.setItem(a+t.key,JSON.stringify(e))}}});