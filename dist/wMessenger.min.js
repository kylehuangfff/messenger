!function(e,t){"function"==typeof define&&define.amd?define(t):e.wMessenger=t()}(this,function(){"use strict";var a=[],r="wMessenger-",o=Object.prototype.toString,d=function(){return+new Date};return{addListener:function(n){n=n||{};var i=[];if("[object Function]"!==o.call(n.cb))throw new Error("wMessenger Error: cb值必须为函数");if("[object String]"===o.call(n.key))i.push(r+n.key);else{if(!Array.isArray(n.key))throw new Error("wMessenger Error: 监听的key值必须为字符串或字符串数组");i=n.key.map(function(e){return r+e})}var e=function(e){var t;if(-1!==i.indexOf(e.key)&&(t=null===e.oldValue?"add":null===e.newValue?"delete":"update",!n.type||n.type===t)){var a,r=JSON.parse(e.newValue);if(r&&(a=/^\{.*\}$/.test(r.data)||/^\[.*\]$/.test(r.data)?JSON.parse(r.data):r.data),void 0!==n.data&&null!==n.data)if(Array.isArray(n.data)||"[object Object]"===o.call(n.data)){if(JSON.stringify(n.data)!==r.data)return}else if(n.data!==r.data)return;n.cb(a)}},t=d();return a[t]=e,window.addEventListener("storage",e,!0),t},removeListener:function(e){a[e]&&window.removeEventListener("storage",a[e],!0),a[e]=null},broadcast:function(e){if(!(e=e||{}).key||"[object String]"!==o.call(e.key))throw new Error("wMessenger Error: 广播的key值必须为字符串");var t={};t.t=(new Date).getTime()+""+Math.floor(1e3*Math.random()),void 0!==e.data&&null!==e.data&&(Array.isArray(e.data)||"[object Object]"===o.call(e.data)?t.data=JSON.stringify(e.data):t.data=e.data),window.localStorage.setItem(r+e.key,JSON.stringify(t))}}});